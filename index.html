<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TeX Render</title>

  <link rel="icon" href="./favicon.ico" sizes="any">
  <link rel="icon" type="image/svg+xml" href="./favicon.svg">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">

  <style>
    :root{
      --bg:#e5e5e5;--panel:#d6d6d6;--panel2:#cfcfcf;--border:#bdbdbd;
      --text:#2b2b2b;--r:6px;--gap:14px;--max:1000px;
      --font:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font)}
    .wrap{max-width:var(--max);margin:0 auto;padding:20px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}

    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);padding:16px}
    h2{margin:0 0 10px;font-size:16px;font-weight:600}

    textarea,select,button,input{
      width:100%;
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:10px 12px;
      font:14px var(--mono);
      color:var(--text);
    }
    textarea{min-height:200px;resize:vertical;background:#fff}
    select,button,input{background:var(--panel2)}

    .row{display:flex;gap:10px;margin-top:10px}
    .row>*{flex:1}

    .out{
      background:#fff;border:1px solid var(--border);border-radius:var(--r);
      padding:12px;min-height:200px;overflow:auto;font-size:1.3em
    }
    .err{
      margin-top:10px;padding:10px 12px;border-radius:var(--r);border:1px solid var(--border);
      background:var(--panel2);font:12px var(--mono);color:#3a1f1f;white-space:pre-wrap;display:none
    }

    .help{margin-top:12px;padding:12px;background:#ececec;border:1px solid var(--border);border-radius:var(--r);font:12px var(--mono)}
    .help b{display:block;font-weight:600;font-size:13px;margin-bottom:6px}
    .help-search{height:30px;padding:6px 8px;border-radius:4px;border:1px solid var(--border);background:#fff;margin:6px 0 10px}
    .help-stack{position:relative;min-height:170px;border:1px solid #c8c8c8;background:#f3f3f3;border-radius:4px;padding:6px}
    .help-pane{display:flex;flex-direction:column;gap:4px}
    .help-pane.overlay{position:absolute;inset:6px;border-radius:4px;background:#f3f3f3;overflow:auto}
    .help-item{padding:3px 6px;border-radius:4px;cursor:pointer}
    .help-item:hover{background:#dddddd}
    .help-overlay-title{padding:3px 6px 6px;border-bottom:1px solid #d0d0d0;margin-bottom:4px;position:sticky;top:0;background:#f3f3f3}
    .help-status{color:#666;padding:6px}

    .docbar{
      display:flex;align-items:center;gap:12px;padding:10px 12px;margin-top:14px;
      background:var(--panel);border:1px solid var(--border);border-radius:var(--r);
      font:13px var(--mono);overflow:auto;white-space:nowrap;
    }
    .docbar a{color:inherit;text-decoration:underline}
    .docbar .sep{opacity:.6}

    .fieldwrap{position:relative;padding-top:14px}

    .clipbtn{
      position:absolute;top:-30px;right:8px;
      width:36px;height:36px;padding:0;
      display:grid;place-items:center;
      border:1px solid var(--border);
      border-radius:10px;
      background:var(--panel2);
      cursor:pointer;
      z-index:2;
    }
    .clipbtn:hover{background:#fff}
    .clipbtn:active{transform:translateY(1px)}
    .clipicon{width:20px;height:20px;fill:currentColor;opacity:.85}

    .acbtn{right:52px}
    .acbtn.on{background:#fff}
    .acbtn.off{opacity:.55}

    /* Autocomplete */
    .ac{
      position:absolute;
      left:0; right:0;
      top:100%;
      margin-top:8px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:10px;
      box-shadow:0 8px 24px rgba(0,0,0,.12);
      max-height:260px;
      overflow:auto;
      z-index:5;
      display:none;
    }
    .ac-row{padding:8px 10px;border-radius:8px;cursor:pointer}
    .ac-row:hover{background:#efefef}
    .ac-row.sel{background:rgba(0,0,0,.08)}
    .ac-tex{font:13px var(--mono);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ac-title{font:12px var(--font);opacity:.75;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ac-hint{padding:8px 10px;font:12px var(--mono);opacity:.65}
  </style>
</head>
<body>
<div class="wrap">
  <div class="grid">

    <div class="card">
      <h2>Input</h2>

      <div class="fieldwrap">
        <button id="copyInput" class="clipbtn" type="button" aria-label="Copy TeX">
          <svg viewBox="0 0 24 24" class="clipicon" aria-hidden="true">
            <path d="M16 4h-1.18A3 3 0 0 0 12 2a3 3 0 0 0-2.82 2H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-1h-2v1H8V6h1.18A3 3 0 0 0 12 8a3 3 0 0 0 2.82-2H16v3h2V6a2 2 0 0 0-2-2Z"/>
            <path d="M20 8h-6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Z"/>
          </svg>
        </button>

        <button id="toggleAc" class="clipbtn acbtn" type="button" aria-label="Toggle autocomplete">
          <svg viewBox="0 0 24 24" class="clipicon" aria-hidden="true">
            <path d="M3 17h2l1-3h6l1 3h2L9.5 4h-2L3 17zm3.6-5 2.4-7 2.4 7H6.6zM19 17h2v-7h-2v7zm0-9h2V6h-2v2z"/>
          </svg>
        </button>

        <textarea id="src">\frac{a^2+b^2}{c}</textarea>
        <div id="ac" class="ac" aria-label="Autocomplete"></div>
      </div>

      <div class="row">
        <select id="mode">
          <option value="display">display</option>
          <option value="inline">inline</option>
        </select>
        <button id="clear">clear</button>
      </div>

      <div class="help">
        <b>Шпаргалка</b>
        <input id="helpSearch" class="help-search" placeholder="поиск по help.json…">
        <div class="help-stack">
          <div id="helpBase" class="help-pane">
            <div class="help-item" data-tex="\frac{a}{b}">\frac{a}{b}</div>
            <div class="help-item" data-tex="x^2">x^2</div>
            <div class="help-item" data-tex="x_i">x_i</div>
            <div class="help-item" data-tex="\sqrt{x}">\sqrt{x}</div>
            <div class="help-item" data-tex="\int_a^b f(x)\,dx">\int_a^b f(x)\,dx</div>
            <div class="help-item" data-tex="\sum_{k=1}^{n} a_k">\sum_{k=1}^{n} a_k</div>
            <div class="help-item" data-tex="\begin{pmatrix}a&b\\c&d\end{pmatrix}">pmatrix</div>
            <div class="help-item" data-tex="\ce{2H2 + O2 -> 2H2O}">\ce{2H2 + O2 -> 2H2O}</div>
          </div>
          <div id="helpOverlay" class="help-pane overlay" style="display:none">
            <div class="help-overlay-title">Результаты</div>
            <div id="helpResults"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Output</h2>

      <div class="fieldwrap">
        <div id="out" class="out"></div>
      </div>

      <div id="err" class="err"></div>
    </div>

  </div>

  <div class="docbar">
    <span>Docs:</span>
    <a href="https://katex.org/docs/supported.html" target="_blank" rel="noopener">Supported</a>
    <span class="sep">|</span>
    <a href="https://katex.org/docs/supported.html#mhchem" target="_blank" rel="noopener">Supported chemistry</a>
  </div>
</div>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/mhchem.min.js"></script>
<script defer src="./autocomplete.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const src=document.getElementById("src"),out=document.getElementById("out"),err=document.getElementById("err"),
        mode=document.getElementById("mode"),clearBtn=document.getElementById("clear");

  const toggleAcBtn = document.getElementById("toggleAc");
  let acEnabled = localStorage.getItem("texfast.acEnabled");
  acEnabled = (acEnabled === null) ? true : (acEnabled === "1");

  function paintAcBtn(){
    toggleAcBtn.classList.toggle("on", acEnabled);
    toggleAcBtn.classList.toggle("off", !acEnabled);
    toggleAcBtn.title = acEnabled ? "Autocomplete: ON" : "Autocomplete: OFF";
  }
  paintAcBtn();

  function showErr(msg){
    err.style.display="block";
    err.textContent=String(msg);
  }

  let t=0;
  function renderNow(){
    err.style.display="none";
    try{
      katex.render(src.value,out,{displayMode:mode.value==="display",throwOnError:true,trust:false});
    }catch(e){
      out.textContent="";
      showErr(e);
    }
  }

  function schedule(){clearTimeout(t);t=setTimeout(renderNow,60)}
  src.addEventListener("input",schedule);
  mode.addEventListener("change",renderNow);
  clearBtn.addEventListener("click",()=>{src.value="";renderNow()});

  function insertTex(tex){
    const s=src.selectionStart,e=src.selectionEnd;
    src.value=src.value.slice(0,s)+tex+src.value.slice(e);
    src.selectionStart=src.selectionEnd=s+tex.length;
    src.focus();
    schedule();
  }

  function replaceRange(a,b,tex){
    src.value = src.value.slice(0,a)+tex+src.value.slice(b);
    src.selectionStart = src.selectionEnd = a+tex.length;
    src.focus();
    schedule();
  }

  document.querySelectorAll("#helpBase .help-item")
    .forEach(el=>el.onclick=()=>insertTex(el.dataset.tex||""));

  const helpSearch=document.getElementById("helpSearch"),
        helpBase=document.getElementById("helpBase"),
        helpOverlay=document.getElementById("helpOverlay"),
        helpResults=document.getElementById("helpResults");

  let helpData=[],helpLoaded=false;

  function setSearchMode(on){
    helpBase.style.visibility=on?"hidden":"visible";
    helpOverlay.style.display=on?"block":"none";
  }

  function showStatus(t){
    helpResults.innerHTML="";
    const d=document.createElement("div");
    d.className="help-status";
    d.textContent=t;
    helpResults.appendChild(d);
  }

  fetch("./help.json", { cache: "force-cache" })
    .then(r=>r.json())
    .then(d=>{
      helpData = Array.isArray(d) ? d : [];
      helpLoaded = true;
      window.dispatchEvent(new Event("texfast:helpLoaded"));
    })
    .catch(()=>{
      helpLoaded = false;
      window.dispatchEvent(new Event("texfast:helpLoaded"));
    });

  function renderJson(q){
    const qq=q.trim().toLowerCase();
    if(!qq){setSearchMode(false);return}
    setSearchMode(true);
    if(!helpLoaded){showStatus("help.json не загружен");return}
    helpResults.innerHTML="";
    let n=0;
    for(const it of helpData){
      const hay=((it.tex||"")+" "+(it.title||"")+" "+(it.keys||[]).join(" ")).toLowerCase();
      if(!hay.includes(qq))continue;
      const d=document.createElement("div");
      d.className="help-item";
      d.textContent=(it.tex||"")+" — "+(it.title||"");
      d.onclick=()=>insertTex(it.tex||"");
      helpResults.appendChild(d);
      if(++n>=120)break;
    }
    if(!n)showStatus("Ничего не найдено");
  }

  helpSearch.addEventListener("input",e=>renderJson(e.target.value));

  if("serviceWorker"in navigator)navigator.serviceWorker.register("./sw.js");

  document.getElementById("copyInput").onclick = async () => {
    err.style.display="none";
    try{
      await navigator.clipboard.writeText(src.value);
    }catch(e){
      showErr(e);
    }
  };

  toggleAcBtn.onclick = () => {
    acEnabled = !acEnabled;
    localStorage.setItem("texfast.acEnabled", acEnabled ? "1" : "0");
    paintAcBtn();
    if (window.TEXFAST_API) window.TEXFAST_API.acEnabled = acEnabled;
    window.dispatchEvent(new Event("texfast:acToggle"));
  };

  window.TEXFAST_API = {
    acEnabled,
    getHelp: () => ({ loaded: helpLoaded, data: helpData }),
    insertTex,
    replaceRange,
    src,
    acEl: document.getElementById("ac"),
    schedule
  };
  window.dispatchEvent(new Event("texfast:apiReady"));

  renderNow();
});
</script>
</body>
</html>
